version: "3.8"

# =============================================================================
# TeachTrack Production Docker Compose - Optimized for Contabo VPS 10 (8GB RAM)
# =============================================================================
# Backend URL: https://teachtrackke.duckdns.org
# Frontend URL: https://teachtrackke.vercel.app
# =============================================================================

services:
  # MySQL Database - Optimized for 8GB VPS
  db:
    image: mysql:8.0
    container_name: teachtrack_db
    restart: always
    environment:
      MYSQL_DATABASE: teachtrack
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "127.0.0.1:3306:3306" # Only accessible locally
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d
    command: >
      --max_connections=200
      --innodb_buffer_pool_size=1G
      --innodb_buffer_pool_instances=2
      --innodb_log_file_size=256M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      --skip-name-resolve
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${DB_ROOT_PASSWORD}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1.5G

  # Redis for caching and sessions
  redis:
    image: redis:7-alpine
    container_name: teachtrack_redis
    restart: always
    ports:
      - "127.0.0.1:6379:6379" # Only accessible locally
    volumes:
      - redis_data:/data
    command: >
      redis-server 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru 
      --save 60 1000
      --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 300M

  # Backend API - FastAPI with Uvicorn
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.production
    container_name: teachtrack_backend
    restart: always
    ports:
      - "127.0.0.1:8000:8000" # Only accessible via Nginx
    environment:
      - ENV=production
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=mysql+pymysql://${DB_USER}:${DB_PASSWORD}@db:3306/teachtrack
      - REDIS_URL=redis://redis:6379/0
      - ALLOWED_ORIGINS=https://teachtrackke.vercel.app,https://teachtrackke.duckdns.org
      - FRONTEND_URL=https://teachtrackke.vercel.app
      # Cloudinary
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      # Google OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      # SMTP
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - FROM_EMAIL=${FROM_EMAIL}
      - FROM_NAME=${FROM_NAME}
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G

  # Celery Worker for background tasks (optional - uncomment if needed)
  # celery_worker:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile.production
  #   container_name: teachtrack_celery
  #   restart: always
  #   command: celery -A celery_app worker --loglevel=info --concurrency=2
  #   environment:
  #     - ENV=production
  #     - DATABASE_URL=mysql+pymysql://${DB_USER}:${DB_PASSWORD}@db:3306/teachtrack
  #     - REDIS_URL=redis://redis:6379/0
  #   depends_on:
  #     - db
  #     - redis
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M

  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: teachtrack_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - backend
    command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''

  # Certbot for SSL certificates
  certbot:
    image: certbot/certbot
    container_name: teachtrack_certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    name: teachtrack_network
